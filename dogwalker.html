<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SniffMap ğŸ¶</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        :root {
            --primary: #FF6B6B;
            --secondary: #4ECDC4;
            --dark: #2C3E50;
        }

        /* å…¨å±é‡ç½® */
        body, html { 
            margin: 0; padding: 0; 
            height: 100%; width: 100%; 
            overflow: hidden; /* ç¦æ­¢é¡µé¢æ»šåŠ¨ */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        #map { height: 100%; width: 100%; z-index: 1; }

        /* é¡¶éƒ¨æµ®åŠ¨å¡ç‰‡ */
        .top-card {
            position: absolute;
            top: 20px; left: 15px; right: 15px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo { font-weight: 800; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .logo i { color: var(--primary); font-size: 20px; }
        
        .status-badge {
            background: #e6fffa; color: #00b894;
            padding: 4px 10px; border-radius: 20px;
            font-size: 12px; font-weight: 600;
        }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .bottom-panel {
            position: absolute;
            bottom: 30px; left: 15px; right: 15px;
            background: var(--dark);
            color: white;
            padding: 15px 20px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .btn-record {
            width: 56px; height: 56px;
            background: var(--primary);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px;
            border: 4px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-record:active { transform: scale(0.9); }

        .stat-box { text-align: center; min-width: 60px; }
        .stat-val { font-size: 20px; font-weight: 700; font-variant-numeric: tabular-nums; }
        .stat-label { font-size: 10px; opacity: 0.6; margin-top: 2px; }

        /* åœ°å›¾æ ‡è®°æ ·å¼ */
        .emoji-marker { font-size: 28px; text-align: center; line-height: 1; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        
        /* è·¯çº¿é€‰æ‹©å™¨ (ç®€åŒ–ç‰ˆ) */
        .route-pill {
            position: absolute;
            top: 90px; left: 15px;
            z-index: 999;
            display: flex; gap: 10px;
            overflow-x: auto;
            padding-right: 15px;
            width: 100%;
            scrollbar-width: none; /* éšè—æ»šåŠ¨æ¡ */
        }
        .pill {
            background: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            color: #555;
            border: 1px solid transparent;
        }
        .pill.active { background: var(--secondary); color: white; box-shadow: 0 4px 12px rgba(78, 205, 196, 0.4); }

    </style>
</head>
<body>

    <div class="top-card">
        <div class="logo"><i class="fas fa-dog"></i> SniffMap</div>
        <div class="status-badge" id="gps-status"><i class="fas fa-location-arrow"></i> æ¨¡æ‹Ÿå®šä½</div>
    </div>

    <div class="route-pill">
        <div class="pill active" onclick="filterRoute(0, this)">ğŸ¶ å°ç‹—å‹å¥½</div>
        <div class="pill" onclick="filterRoute(1, this)">ğŸŒ² æ£®æ—å¾’æ­¥</div>
        <div class="pill" onclick="filterRoute(2, this)">â˜• ç¤¾äº¤å’–å•¡</div>
    </div>

    <div class="bottom-panel">
        <div class="stat-box">
            <div class="stat-val" id="time">00:00</div>
            <div class="stat-label">æ—¶é•¿</div>
        </div>
        
        <div class="btn-record" id="recordBtn" onclick="toggleRecord()">
            <i class="fas fa-play" id="playIcon"></i>
        </div>

        <div class="stat-box">
            <div class="stat-val" id="dist">0.0</div>
            <div class="stat-label">å…¬é‡Œ</div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // åˆå§‹åŒ–åœ°å›¾ - é»˜è®¤å®šä½åˆ° ä¸Šæµ·é™å®‰å…¬å›­ (ç¤ºä¾‹)
        // å®é™…æ‰‹æœºä¸Šå¯ä»¥é€šè¿‡ navigator.geolocation è·å–çœŸå®ä½ç½®
        const defaultLat = 31.224361;
        const defaultLng = 121.469170;
        
        const map = L.map('map', {
            zoomControl: false, // éšè—ç¼©æ”¾æŒ‰é’®ï¼Œæ›´åƒApp
            attributionControl: false 
        }).setView([defaultLat, defaultLng], 16);

        // åŠ è½½æ¼‚äº®çš„æˆ·å¤–é£æ ¼åº•å›¾ (CartoDB Voyager)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            maxZoom: 20,
            subdomains: 'abcd'
        }).addTo(map);

        // æ•°æ®ï¼šæ¨¡æ‹Ÿå‡ æ¡è·¯çº¿
        const routesData = [
            { 
                color: '#00b894', 
                coords: [[31.224, 121.469], [31.225, 121.470], [31.226, 121.468], [31.224, 121.469]],
                msg: "è‰åœ°å¹³å¦ï¼Œé€‚åˆæŸ¯åŸºï¼"
            },
            { 
                color: '#2d3436', 
                coords: [[31.222, 121.465], [31.223, 121.462], [31.228, 121.464]], 
                msg: "é•¿è·ç¦»å¾’æ­¥ï¼Œæ³¨æ„è¡¥æ°´"
            },
            { 
                color: '#fdcb6e', 
                coords: [[31.2265, 121.472], [31.2275, 121.473], [31.2270, 121.474]], 
                msg: "è¿™é‡Œå¾ˆå¤šç‹—ç‹—èšä¼š"
            }
        ];

        let currentPolyline = null;

        // åˆ‡æ¢è·¯çº¿åŠŸèƒ½
        function filterRoute(index, el) {
            // UI æ›´æ–°
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');

            // åœ°å›¾æ›´æ–°
            if(currentPolyline) map.removeLayer(currentPolyline);
            
            const route = routesData[index];
            currentPolyline = L.polyline(route.coords, {
                color: route.color,
                weight: 6,
                opacity: 0.8,
                lineCap: 'round'
            }).addTo(map);

            map.fitBounds(currentPolyline.getBounds(), { padding: [100, 100] });
            
            // å¼¹å‡ºæç¤º
            L.popup()
                .setLatLng(route.coords[0])
                .setContent(`<b>${route.msg}</b>`)
                .openOn(map);
        }

        // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€æ¡
        filterRoute(0, document.querySelector('.pill'));

        // æ·»åŠ è®¾æ–½æ ‡è®°
        const addEmoji = (lat, lng, icon) => {
            L.marker([lat, lng], {
                icon: L.divIcon({
                    html: `<div class="emoji-marker">${icon}</div>`,
                    className: 'dummy',
                    iconSize: [30, 30]
                })
            }).addTo(map);
        }
        addEmoji(31.2250, 121.470, 'ğŸš°');
        addEmoji(31.2230, 121.462, 'â˜•');

        // è®¡æ—¶å™¨é€»è¾‘
        let timer = null;
        let sec = 0;
        let dist = 0;

        function toggleRecord() {
            const btn = document.getElementById('recordBtn');
            const icon = document.getElementById('playIcon');
            
            if(!timer) {
                // å¼€å§‹
                icon.className = 'fas fa-pause';
                btn.style.backgroundColor = '#ff9f43';
                timer = setInterval(() => {
                    sec++;
                    // æ›´æ–°æ—¶é—´
                    const m = String(Math.floor(sec/60)).padStart(2,'0');
                    const s = String(sec%60).padStart(2,'0');
                    document.getElementById('time').innerText = `${m}:${s}`;
                    
                    // æ¨¡æ‹Ÿè·ç¦»å¢åŠ 
                    dist += 0.01;
                    document.getElementById('dist').innerText = dist.toFixed(2);
                }, 1000);
            } else {
                // æš‚åœ
                icon.className = 'fas fa-play';
                btn.style.backgroundColor = '#FF6B6B';
                clearInterval(timer);
                timer = null;
                alert("é›ç‹—ç»“æŸï¼å·²ç”Ÿæˆå—…æ¢çƒ­åŠ›å›¾ ğŸ”¥");
            }
        }

        // å°è¯•è·å–çœŸå®å®šä½ (æ‰‹æœºä¸Šé€šå¸¸éœ€è¦HTTPSæ‰èƒ½ç”Ÿæ•ˆ)
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                const { latitude, longitude } = pos.coords;
                map.setView([latitude, longitude], 16);
                L.marker([latitude, longitude]).addTo(map).bindPopup("ä½ åœ¨è¿™é‡Œ").openPopup();
                document.getElementById('gps-status').innerHTML = '<i class="fas fa-location-arrow"></i> çœŸå®å®šä½';
            });
        }
    </script>
</body>
</html>
